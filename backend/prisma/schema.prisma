// Prisma schema for VLS Automation SaaS

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id               Int            @id @default(autoincrement())
  email            String         @unique
  passwordHash     String         @map("password_hash")
  fullName         String?        @map("full_name")
  subscriptionTier String         @default("free") @map("subscription_tier") // free, basic, pro, business
  stripeCustomerId String?        @map("stripe_customer_id")

  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")

  // Relations
  workflows        Workflow[]
  listings         Listing[]
  automationRuns   AutomationRun[]
  subscription     Subscription?

  @@map("users")
}

model Workflow {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  name        String
  description String?
  website     String   // e.g., 'vlshomes.com'
  status      String   @default("learning") // learning, ready, active

  // Recorded actions from AI learning phase
  recordedActions Json?   @map("recorded_actions") // Array of {action, selector, value, timestamp}

  // Field mappings (CSV column â†’ web form field)
  fieldMappings   Json?   @map("field_mappings") // {csv_column: selector, ...}

  // Success criteria
  successIndicators Json? @map("success_indicators") // How to know upload succeeded

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  listings       Listing[]
  automationRuns AutomationRun[]

  @@map("workflows")
}

model Listing {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")
  workflowId Int?     @map("workflow_id")

  // Listing data
  mlsNumber   String?  @map("mls_number")
  address     String?
  city        String?
  state       String?
  zipCode     String?  @map("zip_code")
  price       Float?
  bedrooms    Int?
  bathrooms   Float?
  squareFeet  Int?     @map("square_feet")
  description String?
  listingData Json?    @map("listing_data") // Full listing details

  // Upload status
  uploadStatus String?   @default("pending") @map("upload_status") // pending, processing, completed, failed
  uploadResult Json?     @map("upload_result") // Error messages, success confirmation
  uploadedAt   DateTime? @map("uploaded_at")

  // Image URLs (stored as JSON in SQLite)
  imageUrls   String?  @map("image_urls") // JSON string array for SQLite

  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workflow Workflow? @relation(fields: [workflowId], references: [id], onDelete: SetNull)

  @@map("listings")
}

model AutomationRun {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")
  workflowId Int      @map("workflow_id")

  runType    String   // 'ai_learning', 'deterministic', 'api_sync'
  status     String   @default("running") // running, completed, failed

  totalListings      Int?     @map("total_listings")
  successfulListings Int?     @default(0) @map("successful_listings")
  failedListings     Int?     @default(0) @map("failed_listings")

  startedAt   DateTime  @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")
  errorLog    Json?     @map("error_log")

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@map("automation_runs")
}

model Subscription {
  id                   Int       @id @default(autoincrement())
  userId               Int       @unique @map("user_id")
  stripeSubscriptionId String?   @map("stripe_subscription_id")
  plan                 String    // basic, pro, business
  status               String    // active, canceled, past_due
  currentPeriodStart   DateTime? @map("current_period_start")
  currentPeriodEnd     DateTime? @map("current_period_end")

  // Usage tracking
  monthlyRunsUsed  Int  @default(0) @map("monthly_runs_used")
  monthlyRunsLimit Int  @map("monthly_runs_limit")

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}
